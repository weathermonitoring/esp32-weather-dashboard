<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Door Monitor</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0f14; color:#e6edf3; margin:0; padding:24px; }
    .wrap { max-width: 720px; margin: 0 auto; }
    .card { background:#121822; border:1px solid #233044; border-radius:16px; padding:18px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .pill { padding:6px 10px; border-radius:999px; background:#1c2533; border:1px solid #2a3a52; font-size:12px; }
    .status {
      margin-top:16px;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:18px; border-radius:16px; border:1px solid #2a3a52; background:#0f1520;
    }
    .big { font-size:44px; font-weight:800; letter-spacing:1px; }
    .muted { color:#9fb1c7; font-size:13px; }
    .dot { width:12px; height:12px; border-radius:50%; background:#666; box-shadow: 0 0 0 4px rgba(255,255,255,0.03); }
    .ok { background:#2ecc71; }
    .bad { background:#e74c3c; }
    .btn { cursor:pointer; padding:10px 12px; border-radius:12px; border:1px solid #2a3a52; background:#121822; color:#e6edf3; }
    input { width:100%; padding:10px 12px; border-radius:12px; border:1px solid #2a3a52; background:#0f1520; color:#e6edf3; }
    label { display:block; margin:10px 0 6px; font-size:12px; color:#9fb1c7; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:0 0 12px;">Smart Door Monitoring</h2>

    <div class="card">
      <div class="row">
        <div class="pill" id="connPill">Disconnected</div>
        <div class="pill" id="topicPill">Topic: smartdoor/state</div>
      </div>

      <div class="status">
        <div>
          <div class="muted">Door State</div>
          <div class="big" id="doorText">---</div>
          <div class="muted" id="lastMsg">No data yet</div>
        </div>
        <div style="text-align:right;">
          <div class="muted">Broker</div>
          <div style="font-size:13px;" id="brokerText">â€”</div>
          <div style="display:flex; justify-content:flex-end; margin-top:10px;">
            <div class="dot" id="connDot"></div>
          </div>
        </div>
      </div>

      <details style="margin-top:14px;">
        <summary class="btn">Connection settings</summary>

        <label>Broker host (HiveMQ cluster)</label>
        <input id="host" placeholder="e.g. xxxxx.s1.eu.hivemq.cloud" />

        <label>WebSocket TLS port</label>
        <input id="port" value="8884" />

        <label>Username</label>
        <input id="user" placeholder="hivemq.webclient...." />

        <label>Password</label>
        <input id="pass" type="password" placeholder="your password" />

        <label>Topic</label>
        <input id="topic" value="smartdoor/state" />

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="btnConnect">Connect</button>
          <button class="btn" id="btnDisconnect">Disconnect</button>
        </div>
      </details>
    </div>
  </div>

  <!-- MQTT.js (browser) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    let client = null;

    const elDoor = document.getElementById("doorText");
    const elLast = document.getElementById("lastMsg");
    const elDot  = document.getElementById("connDot");
    const elPill = document.getElementById("connPill");
    const elBrokerText = document.getElementById("brokerText");
    const elTopicPill  = document.getElementById("topicPill");

    function setConn(ok, text){
      elDot.className = "dot " + (ok ? "ok" : "");
      elPill.textContent = text;
      elPill.style.background = ok ? "#14301f" : "#1c2533";
      elPill.style.borderColor = ok ? "#2ecc71" : "#2a3a52";
    }

    function applyState(state){
      const s = (state || "").toUpperCase().trim();
      elDoor.textContent = s || "---";

      // color
      if (s === "OPEN") {
        elDoor.style.color = "#2ecc71";
      } else if (s === "CLOSED") {
        elDoor.style.color = "#e74c3c";
      } else {
        elDoor.style.color = "#e6edf3";
      }
      elLast.textContent = "Updated: " + new Date().toLocaleString();
    }

    function connect(){
      const host = document.getElementById("host").value.trim();
      const port = document.getElementById("port").value.trim();
      const user = document.getElementById("user").value.trim();
      const pass = document.getElementById("pass").value;
      const topic = document.getElementById("topic").value.trim() || "smartdoor/state";

      if(!host){ alert("Put broker host"); return; }

      const url = `wss://${host}:${port}/mqtt`;
      elBrokerText.textContent = url;
      elTopicPill.textContent = "Topic: " + topic;

      if(client){ client.end(true); client = null; }

      setConn(false, "Connecting...");

      client = mqtt.connect(url, {
        username: user,
        password: pass,
        reconnectPeriod: 2000,
        connectTimeout: 8000,
        clean: true
      });

      client.on("connect", () => {
        setConn(true, "Connected");
        client.subscribe(topic, { qos: 0 }, (err) => {
          if(err) console.log("sub err", err);
        });
      });

      client.on("reconnect", () => setConn(false, "Reconnecting..."));
      client.on("close", () => setConn(false, "Disconnected"));
      client.on("error", (e) => { console.log(e); setConn(false, "Error"); });

      client.on("message", (t, payload) => {
        const msg = payload.toString();
        // accept plain OPEN/CLOSED or JSON
        try {
          if(msg.trim().startsWith("{")){
            const obj = JSON.parse(msg);
            if(obj.state) applyState(obj.state);
            else applyState(msg);
          } else {
            applyState(msg);
          }
        } catch {
          applyState(msg);
        }
      });
    }

    function disconnect(){
      if(client){
        client.end(true);
        client = null;
      }
      setConn(false, "Disconnected");
    }

    document.getElementById("btnConnect").addEventListener("click", connect);
    document.getElementById("btnDisconnect").addEventListener("click", disconnect);

    // nice default if you want: auto-fill from localStorage
  </script>
</body>
</html>
